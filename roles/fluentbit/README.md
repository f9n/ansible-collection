# f9n.general.fluentbit

Installs and configures the Fluent Bit log processor and forwarder.

## Role variables

### General (defaults: `defaults/main.yml`)

| Variable | Default | Description |
|----------|---------|-------------|
| `fluentbit_version` | `4.2.2` | Fluent Bit version |
| `fluentbit_service_flush` | `1` | Flush interval (seconds) |
| `fluentbit_service_daemon` | `false` | Daemon mode |
| `fluentbit_service_loglevel` | `info` | Log level |
| `fluentbit_service_http` | `server: on`, `listen: 0.0.0.0`, `port: 2020` | HTTP/metrics server |
| `fluentbit_service_storage` | metrics/path/sync/backlog | Storage settings |
| `fluentbit_includes` | `[]` | Additional include files |
| `fluentbit_pipelines` | Single pipeline, stdout output | Input/Filter/Output pipeline list |
| `fluentbit_custom_config` | `""` | Raw extra YAML config |

### Linux systemd overrides

| Variable | Default | Description |
|----------|---------|-------------|
| `fluentbit_systemd_limit_no_file` | `""` | `LimitNOFILE` value in the systemd override file. Empty = no override. |
| `fluentbit_systemd_memory_max` | `300M` | `MemoryMax` value. Also enables `MemoryAccounting`. Empty = no override. |
| `fluentbit_systemd_io_weight` | `1` | `IOWeight` value. Also enables `IOAccounting`. Empty = no override. |

## Usage

### Minimal (default pipeline: stdout)

```yaml
- hosts: all
  roles:
    - role: f9n.general.fluentbit
```

### Example: tail input + New Relic + OpenTelemetry

Define the pipeline in `group_vars` or `host_vars`:

```yaml
fluentbit_pipelines:
  - inputs:
      - name: tail
        path: "/var/log/app/*.log"
        tag: app_logs
        mem_buf_limit: 50MB
    filters: []
    outputs:
      - name: nrlogs
        match: "*"
        api_key: "{{ vault_newrelic_api_key }}"
      - name: opentelemetry
        match: "*"
        host: otel-collector.example.com
        port: 4318
        tls: on
```

## Notes

- Linux: systemd service and config/parsers under `/etc/fluent-bit/`.
- Windows: Service is registered as `fluent-bit`; firewall rule is added when HTTP metrics are enabled.
- Pipeline structure (inputs/filters/outputs) is generated by the `fluent-bit.yaml.j2` template; customize with `fluentbit_pipelines` and `fluentbit_custom_config`.
