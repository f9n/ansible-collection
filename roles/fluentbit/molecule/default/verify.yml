---
- name: Verify
  hosts: all
  gather_facts: true
  tasks:
    - name: Check Fluent Bit service is running
      ansible.builtin.service_facts:
      become: true

    - name: Assert fluent-bit service is active
      ansible.builtin.assert:
        that:
          - "'fluent-bit.service' in ansible_facts.services"
          - "ansible_facts.services['fluent-bit.service'].state == 'running'"

    - name: Check config file exists
      ansible.builtin.stat:
        path: /etc/fluent-bit/fluent-bit.yml
      register: _config_stat

    - name: Assert config file is present
      ansible.builtin.assert:
        that:
          - _config_stat.stat.exists

    - name: Wait for Fluent Bit to emit records
      ansible.builtin.pause:
        seconds: 3

    - name: Get Fluent Bit journal output
      ansible.builtin.command:
        cmd: journalctl -u fluent-bit --no-pager -n 100
      register: _journal_output
      changed_when: false
      become: true

    - name: Show Fluent Bit journal output
      ansible.builtin.debug:
        var: _journal_output.stdout_lines

    - name: Assert expected message appears in output
      ansible.builtin.assert:
        that:
          - '"oflu" in _journal_output.stdout'
        fail_msg: "Expected message 'oflu' not found in Fluent Bit output"
